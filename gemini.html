<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Inline Styles for Custom UI Elements, Animations, and Theming -->
    <style>
        :root {
            --bg-light: #f0f2f5;
            --bg-dark: #1a1e23;
            --card-light: rgba(255, 255, 255, 0.7);
            --card-dark: rgba(42, 48, 56, 0.7);
            --text-light: #1f2937;
            --text-dark: #e5e7eb;
            --border-light: rgba(209, 213, 219, 0.5);
            --border-dark: rgba(75, 85, 99, 0.5);
            --primary-accent: #4f46e5;
            --high-priority: #ef4444;
            --medium-priority: #f97316;
            --low-priority: #22c55e;
            font-family: 'Inter', sans-serif;
        }

        /* Base styles */
        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark theme */
        body.dark {
            --bg-light: var(--bg-dark);
            --card-light: var(--card-dark);
            --text-light: var(--text-dark);
            --border-light: var(--border-dark);
        }

        /* Glassmorphism effect for cards */
        .glass-card {
            background-color: var(--card-light);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-light);
            transition: background-color 0.3s, border 0.3s, transform 0.2s;
        }
        .glass-card:hover {
            transform: translateY(-4px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary-accent); border-radius: 4px; }

        /* Drag and drop placeholder */
        .placeholder {
            background: rgba(79, 70, 229, 0.1);
            border: 2px dashed var(--primary-accent);
            border-radius: 12px;
            height: 60px;
            margin: 8px 0;
        }

        /* Task dragging style */
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        /* Progress ring */
        .progress-ring-bg { stroke: var(--border-light); }
        .progress-ring-fg { 
            stroke: var(--primary-accent);
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Calendar and Planner grid styles */
        .calendar-grid, .weekly-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .weekly-grid {
             grid-template-rows: auto repeat(48, 30px); /* 30-min slots from 00:00 to 23:30 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200 min-h-screen">

    <!-- Main Application Wrapper -->
    <div id="app" class="p-4 md:p-6 lg:p-8 max-w-screen-2xl mx-auto">
        
        <!-- Header -->
        <header class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
            <div class="flex items-center space-x-3">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>
                <h1 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">Productivity Hub</h1>
            </div>
            
            <div class="col-span-2 md:col-span-1 flex justify-center items-center space-x-2 md:space-x-4 bg-white/60 dark:bg-slate-800/60 p-2 rounded-full shadow-sm backdrop-blur-sm border border-gray-200 dark:border-slate-700">
                <button data-view="todo" class="view-switcher active bg-indigo-500 text-white px-4 py-1.5 rounded-full text-sm font-semibold">Todo</button>
                <button data-view="weekly" class="view-switcher px-4 py-1.5 rounded-full text-sm font-semibold">Week</button>
                <button data-view="monthly" class="view-switcher px-4 py-1.5 rounded-full text-sm font-semibold">Month</button>
            </div>

            <div class="hidden md:flex items-center justify-end space-x-4">
                <div class="relative w-full max-w-xs">
                    <input id="search-input" type="text" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 rounded-full bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-slate-700">
                    <!-- Icons will be injected by JS -->
                </button>
            </div>
        </header>
        
        <!-- Dashboard Header -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-card p-4 rounded-2xl flex flex-col justify-center">
                <p id="motivational-text" class="text-sm text-gray-500 dark:text-gray-400 font-medium">Loading your day...</p>
                <p id="current-date" class="text-lg font-semibold"></p>
            </div>
            <div class="glass-card p-4 rounded-2xl flex flex-col justify-center items-center text-center">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Countdown to Midnight</p>
                <p id="countdown-timer" class="text-2xl font-bold text-indigo-500 tracking-tighter"></p>
            </div>
            <div class="glass-card p-4 rounded-2xl flex items-center justify-center space-x-4">
                 <div class="relative w-20 h-20">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <circle class="progress-ring-bg stroke-current text-gray-200 dark:text-slate-700" stroke-width="10" cx="50" cy="50" r="45" fill="transparent"></circle>
                        <circle id="progress-ring" class="progress-ring-fg stroke-current text-indigo-500" stroke-width="10" cx="50" cy="50" r="45" fill="transparent" stroke-dasharray="282.6" stroke-dashoffset="282.6"></circle>
                    </svg>
                    <div id="tasks-done-percentage" class="absolute inset-0 flex items-center justify-center text-xl font-bold">0%</div>
                </div>
                <div>
                    <p class="font-semibold">Today's Progress</p>
                    <p id="tasks-done-count" class="text-sm text-gray-500 dark:text-gray-400">0/0 tasks done</p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <main id="main-content">
            
            <!-- TODO LIST VIEW -->
            <div id="todo-view" class="view-content">
                <div class="flex flex-wrap gap-4 mb-4">
                    <div class="flex-grow flex items-center space-x-2">
                        <h2 class="text-2xl font-bold">My Tasks</h2>
                        <button id="add-task-btn" class="bg-indigo-500 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-indigo-600 transition-colors">+</button>
                    </div>
                    <div id="todo-filters" class="flex flex-wrap items-center gap-2">
                        <button data-filter="all" class="filter-btn active bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-full text-sm">All</button>
                        <button data-filter="today" class="filter-btn px-3 py-1 rounded-full text-sm">Today</button>
                        <button data-filter="overdue" class="filter-btn px-3 py-1 rounded-full text-sm">Overdue</button>
                        <button data-filter="high" class="filter-btn px-3 py-1 rounded-full text-sm">High Priority</button>
                        <button data-filter="completed" class="filter-btn px-3 py-1 rounded-full text-sm">Completed</button>
                    </div>
                </div>
                <div id="task-list" class="space-y-3 min-h-[300px]">
                    <!-- Tasks will be rendered here -->
                </div>
            </div>
            
            <!-- WEEKLY PLANNER VIEW -->
            <div id="weekly-view" class="view-content hidden">
                <div class="glass-card rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-week" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">&lt;</button>
                        <h2 id="week-range" class="text-xl font-bold"></h2>
                        <button id="next-week" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">&gt;</button>
                    </div>
                    <div id="weekly-planner-grid" class="grid grid-cols-8 -ml-8">
                       <!-- Time slots and day columns will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- MONTHLY PLANNER VIEW -->
            <div id="monthly-view" class="view-content hidden">
                 <div class="glass-card rounded-2xl p-4">
                     <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">&lt;</button>
                        <h2 id="month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">&gt;</button>
                    </div>
                    <div id="monthly-calendar" class="grid grid-cols-7 gap-1">
                        <!-- Calendar will be generated here -->
                    </div>
                 </div>
            </div>
            
        </main>
    </div>

    <!-- MODAL FOR ADDING/EDITING TASKS -->
    <div id="task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-card rounded-2xl p-6 w-full max-w-md transform transition-all">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Add New Task</h3>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <input id="task-title" type="text" placeholder="e.g., Finish Math Homework" class="w-full p-3 mb-3 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-300 dark:border-slate-600 focus:ring-2 focus:ring-indigo-500" required>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input id="task-due-date" type="date" class="w-full p-3 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-300 dark:border-slate-600">
                    <select id="task-priority" class="w-full p-3 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-300 dark:border-slate-600">
                        <option value="low">Low Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="high">High Priority</option>
                    </select>
                </div>
                <input id="task-tags" type="text" placeholder="Tags (e.g., Assignment, Exam)" class="w-full p-3 mb-4 rounded-lg bg-white/70 dark:bg-slate-800/70 border border-gray-300 dark:border-slate-600">
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-task" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-slate-600">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600">Save Task</button>
                </div>
            </form>
        </div>
    </div>


    <!-- JavaScript Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DOM ELEMENTS ---
        const themeToggle = document.getElementById('theme-toggle');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const currentDateEl = document.getElementById('current-date');
        const motivationalTextEl = document.getElementById('motivational-text');
        const progressRing = document.getElementById('progress-ring');
        const tasksDonePercentageEl = document.getElementById('tasks-done-percentage');
        const tasksDoneCountEl = document.getElementById('tasks-done-count');
        
        const viewSwitchers = document.querySelectorAll('.view-switcher');
        const views = document.querySelectorAll('.view-content');
        
        const taskListEl = document.getElementById('task-list');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const cancelTaskBtn = document.getElementById('cancel-task');
        const todoFilters = document.getElementById('todo-filters');

        const weeklyPlannerGrid = document.getElementById('weekly-planner-grid');
        const weekRangeEl = document.getElementById('week-range');
        const prevWeekBtn = document.getElementById('prev-week');
        const nextWeekBtn = document.getElementById('next-week');

        const monthlyCalendarEl = document.getElementById('monthly-calendar');
        const monthYearEl = document.getElementById('month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');


        // --- STATE MANAGEMENT ---
        let state = {
            tasks: [],
            currentView: 'todo',
            todoFilter: 'all',
            currentDate: new Date(), // For planners
            theme: 'light'
        };

        const priorityMap = {
            high: { class: 'bg-red-500', text: 'High' },
            medium: { class: 'bg-orange-500', text: 'Medium' },
            low: { class: 'bg-green-500', text: 'Low' },
        };
        
        // --- INITIALIZATION ---
        function init() {
            loadState();
            setupEventListeners();
            updateDashboardHeader();
            renderCurrentView();
            setInterval(updateDashboardHeader, 1000);
            initTheme();
        }

        function loadState() {
            const savedState = JSON.parse(localStorage.getItem('productivityHubState'));
            if (savedState) {
                state = { ...state, ...savedState };
                state.tasks = state.tasks.map(t => ({ ...t, dueDate: t.dueDate ? new Date(t.dueDate) : null }));
                state.currentDate = new Date(state.currentDate);
            }
        }

        function saveState() {
            localStorage.setItem('productivityHubState', JSON.stringify(state));
        }

        // --- THEME ---
        function initTheme() {
            if (state.theme === 'dark') {
                document.body.classList.add('dark');
            }
            updateThemeToggleIcon();
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark');
            state.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
            updateThemeToggleIcon();
            saveState();
        }
        
        function updateThemeToggleIcon() {
            const isDark = document.body.classList.contains('dark');
            themeToggle.innerHTML = isDark ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
        }
        
        // --- DASHBOARD HEADER LOGIC ---
        function updateDashboardHeader() {
            const now = new Date();
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);
            
            const diff = endOfDay - now;
            const h = String(Math.floor(diff / (1000 * 60 * 60))).padStart(2, '0');
            const m = String(Math.floor((diff / (1000 * 60)) % 60)).padStart(2, '0');
            const s = String(Math.floor((diff / 1000) % 60)).padStart(2, '0');
            countdownTimerEl.textContent = `${h}:${m}:${s}`;
            
            currentDateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const hour = now.getHours();
            if (hour < 12) motivationalTextEl.textContent = "Good morning! Let's get things done.";
            else if (hour < 18) motivationalTextEl.textContent = "Powering through the afternoon!";
            else motivationalTextEl.textContent = "Finishing strong. You've got this!";

            updateProgress();
        }
        
        function updateProgress() {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const todaysTasks = state.tasks.filter(t => t.dueDate && t.dueDate >= today);
            const completedToday = todaysTasks.filter(t => t.completed);
            
            const total = todaysTasks.length;
            const done = completedToday.length;
            const percentage = total > 0 ? Math.round((done / total) * 100) : 0;
            
            tasksDonePercentageEl.textContent = `${percentage}%`;
            tasksDoneCountEl.textContent = `${done}/${total} tasks done`;
            
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (percentage / 100) * circumference;
            progressRing.style.strokeDashoffset = offset;
        }
        
        // --- VIEW MANAGEMENT ---
        function renderCurrentView() {
            views.forEach(v => v.classList.add('hidden'));
            document.getElementById(`${state.currentView}-view`).classList.remove('hidden');
            
            viewSwitchers.forEach(s => {
                s.classList.remove('active', 'bg-indigo-500', 'text-white');
                if (s.dataset.view === state.currentView) {
                    s.classList.add('active', 'bg-indigo-500', 'text-white');
                }
            });

            if (state.currentView === 'todo') renderTodoList();
            if (state.currentView === 'weekly') renderWeeklyPlanner();
            if (state.currentView === 'monthly') renderMonthlyCalendar();
        }
        
        // --- TODO LIST ---
        function renderTodoList() {
            taskListEl.innerHTML = '';
            const filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                 taskListEl.innerHTML = `<div class="text-center p-8 text-gray-500">No tasks here. Add one to get started!</div>`;
                 return;
            }

            filteredTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `glass-card p-4 rounded-xl flex items-center space-x-4 transition-all duration-300 ${task.completed ? 'opacity-50' : ''}`;
                taskEl.dataset.id = task.id;
                taskEl.draggable = true;

                const priority = priorityMap[task.priority];
                const tagsHTML = task.tags.map(tag => `<span class="bg-gray-200 dark:bg-slate-700 text-xs font-medium px-2 py-0.5 rounded-full">${tag}</span>`).join('');
                
                let dueDateHTML = '';
                if(task.dueDate) {
                    const isOverdue = !task.completed && task.dueDate < new Date();
                    dueDateHTML = `<span class="text-sm ${isOverdue ? 'text-red-500 font-semibold' : 'text-gray-500 dark:text-gray-400'}">${task.dueDate.toLocaleDateString()}</span>`;
                }

                taskEl.innerHTML = `
                    <input type="checkbox" class="task-checkbox h-5 w-5 rounded text-indigo-500 focus:ring-indigo-500 border-gray-300" ${task.completed ? 'checked' : ''}>
                    <div class="flex-grow">
                        <p class="font-semibold ${task.completed ? 'line-through' : ''}">${task.title}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="flex items-center text-sm space-x-1">
                                <span class="w-3 h-3 rounded-full ${priority.class}"></span>
                                <span>${priority.text}</span>
                            </span>
                            ${dueDateHTML}
                            <div class="flex gap-1">${tagsHTML}</div>
                        </div>
                    </div>
                    <button class="edit-task-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">Edit</button>
                    <button class="delete-task-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">Del</button>
                `;
                taskListEl.appendChild(taskEl);
            });
            updateProgress();
        }

        function getFilteredTasks() {
            const today = new Date();
            today.setHours(0,0,0,0);
            switch(state.todoFilter) {
                case 'today': return state.tasks.filter(t => t.dueDate && t.dueDate >= today && t.dueDate < new Date(today.getTime() + 24*60*60*1000));
                case 'overdue': return state.tasks.filter(t => !t.completed && t.dueDate && t.dueDate < today);
                case 'completed': return state.tasks.filter(t => t.completed);
                case 'high': return state.tasks.filter(t => t.priority === 'high');
                default: return state.tasks;
            }
        }
        
        function openTaskModal(task = null) {
            taskForm.reset();
            if (task) {
                document.getElementById('modal-title').textContent = 'Edit Task';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                if (task.dueDate) {
                    document.getElementById('task-due-date').value = task.dueDate.toISOString().split('T')[0];
                }
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-tags').value = task.tags.join(', ');
            } else {
                document.getElementById('modal-title').textContent = 'Add New Task';
                document.getElementById('task-id').value = '';
            }
            taskModal.classList.remove('hidden');
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
        }
        
        // --- WEEKLY PLANNER ---
        function renderWeeklyPlanner() {
            weeklyPlannerGrid.innerHTML = '';
            
            // Add time column
            const timeCol = document.createElement('div');
            for(let i=0; i < 24; i++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'h-[60px] text-right pr-2 text-xs text-gray-400 border-r border-gray-200 dark:border-slate-700';
                timeSlot.style.gridRow = `${i*2 + 2} / span 2`;
                timeSlot.textContent = `${i}:00`;
                timeCol.appendChild(timeSlot);
            }
            weeklyPlannerGrid.appendChild(timeCol);

            const startOfWeek = new Date(state.currentDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); // Sunday
            weekRangeEl.textContent = `${startOfWeek.toLocaleDateString()} - ${new Date(startOfWeek.getTime() + 6*24*60*60*1000).toLocaleDateString()}`;

            for (let day = 0; day < 7; day++) {
                const dayDate = new Date(startOfWeek.getTime() + day * 24 * 60 * 60 * 1000);
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-semibold p-2 border-b border-gray-200 dark:border-slate-700';
                dayHeader.innerHTML = `${dayDate.toLocaleDateString(undefined, {weekday: 'short'})}<br><span class="text-sm font-normal">${dayDate.getDate()}</span>`;
                weeklyPlannerGrid.appendChild(dayHeader);
            }
             // Logic to place tasks on the grid would go here
        }
        
        // --- MONTHLY CALENDAR ---
        function renderMonthlyCalendar() {
            monthlyCalendarEl.innerHTML = '';
            const date = state.currentDate;
            const year = date.getFullYear();
            const month = date.getMonth();

            monthYearEl.textContent = date.toLocaleDateString(undefined, {month: 'long', year: 'numeric'});

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-center text-sm text-gray-500 py-2';
                dayEl.textContent = day;
                monthlyCalendarEl.appendChild(dayEl);
            });

            for (let i = 0; i < firstDay; i++) {
                monthlyCalendarEl.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'border border-gray-200 dark:border-slate-700 p-2 h-24 rounded-md';
                dayEl.textContent = day;
                if (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayEl.classList.add('bg-indigo-100', 'dark:bg-indigo-900');
                }
                monthlyCalendarEl.appendChild(dayEl);
            }
        }
        

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            themeToggle.addEventListener('click', toggleTheme);
            
            viewSwitchers.forEach(s => s.addEventListener('click', () => {
                state.currentView = s.dataset.view;
                renderCurrentView();
            }));

            addTaskBtn.addEventListener('click', () => openTaskModal());
            cancelTaskBtn.addEventListener('click', closeTaskModal);
            
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('task-id').value;
                const taskData = {
                    id: id || Date.now().toString(),
                    title: document.getElementById('task-title').value,
                    dueDate: document.getElementById('task-due-date').value ? new Date(document.getElementById('task-due-date').value) : null,
                    priority: document.getElementById('task-priority').value,
                    tags: document.getElementById('task-tags').value.split(',').map(t => t.trim()).filter(Boolean),
                    completed: id ? state.tasks.find(t => t.id === id).completed : false
                };
                
                if (id) { // Editing
                    state.tasks = state.tasks.map(t => t.id === id ? taskData : t);
                } else { // Adding
                    state.tasks.push(taskData);
                }
                
                saveState();
                renderTodoList();
                closeTaskModal();
            });
            
            taskListEl.addEventListener('click', (e) => {
                const id = e.target.closest('[data-id]').dataset.id;
                if (e.target.classList.contains('task-checkbox')) {
                    const task = state.tasks.find(t => t.id === id);
                    task.completed = !task.completed;
                    saveState();
                    renderTodoList();
                } else if (e.target.classList.contains('edit-task-btn')) {
                    const task = state.tasks.find(t => t.id === id);
                    openTaskModal(task);
                } else if (e.target.classList.contains('delete-task-btn')) {
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    saveState();
                    renderTodoList();
                }
            });

            todoFilters.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    state.todoFilter = e.target.dataset.filter;
                    todoFilters.querySelector('.active').classList.remove('active', 'bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-600', 'dark:text-indigo-300');
                    e.target.classList.add('active', 'bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-600', 'dark:text-indigo-300');
                    renderTodoList();
                }
            });

            // Drag and drop for tasks
            let draggedItem = null;
            taskListEl.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });
            taskListEl.addEventListener('dragend', (e) => {
                draggedItem.classList.remove('dragging');
            });
            taskListEl.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            taskListEl.addEventListener('drop', (e) => {
                e.preventDefault();
                const target = e.target.closest('[data-id]');
                if (target && draggedItem !== target) {
                    const fromId = draggedItem.dataset.id;
                    const toId = target.dataset.id;
                    const fromIndex = state.tasks.findIndex(t => t.id === fromId);
                    const toIndex = state.tasks.findIndex(t => t.id === toId);
                    const [movedTask] = state.tasks.splice(fromIndex, 1);
                    state.tasks.splice(toIndex, 0, movedTask);
                    saveState();
                    renderTodoList();
                }
            });
            
            // Planner navigation
            prevWeekBtn.addEventListener('click', () => { state.currentDate.setDate(state.currentDate.getDate() - 7); renderWeeklyPlanner(); });
            nextWeekBtn.addEventListener('click', () => { state.currentDate.setDate(state.currentDate.getDate() + 7); renderWeeklyPlanner(); });
            prevMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderMonthlyCalendar(); });
            nextMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderMonthlyCalendar(); });
        }
        
        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
